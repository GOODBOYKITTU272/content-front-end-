
import React, { useState } from 'react';
import { Project, Role, WorkflowStage, STAGE_LABELS, Channel } from '../../types';
import { db } from '../../services/mockDb';
import { ArrowLeft, Check, X, RotateCcw, Download, Video, Image as ImageIcon } from 'lucide-react';

interface Props {
  project: Project;
  user: { full_name: string; role: Role };
  onBack: () => void;
  onComplete: () => void;
}

const CeoReviewScreen: React.FC<Props> = ({ project, user, onBack, onComplete }) => {
  const [decision, setDecision] = useState<'APPROVE' | 'REWORK' | 'REJECT' | null>(null);
  const [comment, setComment] = useState('');
  const [reworkStage, setReworkStage] = useState<string>('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = () => {
    if (!decision) return;
    setIsSubmitting(true);

    setTimeout(() => {
        if (decision === 'APPROVE') {
            db.advanceWorkflow(project.id, comment || 'Approved by CEO');
        } else if (decision === 'REWORK') {
            db.rejectTask(project.id, reworkStage as WorkflowStage, comment);
        } else if (decision === 'REJECT') {
            // Full reject goes back to SCRIPT/Draft usually, or a specific REJECTED state
            db.rejectTask(project.id, WorkflowStage.SCRIPT, comment || 'Rejected completely by CEO');
        }
        setIsSubmitting(false);
        onComplete();
    }, 800);
  };

  const getReworkOptions = () => {
    // STRICT CEO LOGIC
    // 1. Script Review Stage: Can ONLY go back to Writer.
    if (project.current_stage === WorkflowStage.SCRIPT_REVIEW_L2) {
         return [{ value: WorkflowStage.SCRIPT, label: 'Writer (Fix Script)' }];
    }

    // 2. Final Review Stage: Can go to Cine, Editor, or Designer. CANNOT go to Writer.
    if (project.current_stage === WorkflowStage.FINAL_REVIEW_L2) {
        const options = [
            { value: WorkflowStage.DESIGN, label: 'Designer (Fix Visuals)' },
        ];
        // If video channel, add Editor/Cine
        if (project.channel !== Channel.LINKEDIN) {
             options.push({ value: WorkflowStage.EDIT, label: 'Editor (Fix Video)' });
             options.push({ value: WorkflowStage.SHOOT, label: 'Cinematographer (Reshoot)' });
        }
        return options;
    }

    // Default fallback (shouldn't happen in CEO flow but good for safety)
    return [{ value: WorkflowStage.SCRIPT, label: 'Writer' }];
  };

  const isVideo = project.channel !== Channel.LINKEDIN;

  return (
    <div className="min-h-screen bg-white font-sans flex flex-col">
      {/* Header */}
      <header className="h-20 border-b-2 border-black flex items-center justify-between px-6 sticky top-0 bg-white z-20 shadow-[0px_4px_0px_0px_rgba(0,0,0,0.05)]">
        <div className="flex items-center space-x-6">
            <button onClick={onBack} className="p-3 border-2 border-transparent hover:border-black hover:bg-slate-100 rounded-full transition-all">
                <ArrowLeft className="w-6 h-6 text-black" />
            </button>
            <div>
                 <h1 className="text-2xl font-black text-slate-900 uppercase tracking-tight">Review: {project.title}</h1>
                 <div className="flex items-center space-x-2 mt-1">
                    <span className={`px-2 py-0.5 text-xs font-black uppercase border-2 border-black text-white ${
                         project.channel === 'YOUTUBE' ? 'bg-[#FF4F4F]' : 
                         project.channel === 'LINKEDIN' ? 'bg-[#0085FF]' : 
                         'bg-[#D946EF]'
                    }`}>
                        {project.channel}
                    </span>
                    <span className="text-xs font-bold uppercase text-slate-500">
                        Stage: {STAGE_LABELS[project.current_stage]}
                    </span>
                 </div>
            </div>
        </div>
      </header>

      <div className="flex-1 flex flex-col md:flex-row max-w-[1920px] mx-auto w-full">
        
        {/* LEFT COLUMN: Content (70%) */}
        <div className="flex-1 p-6 md:p-12 space-y-10 overflow-y-auto bg-slate-50">
            
            {/* Info Block */}
            <div className="bg-white border-2 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] p-6 grid grid-cols-2 md:grid-cols-4 gap-6">
                <div>
                    <label className="block text-xs font-black text-slate-400 uppercase mb-1">Writer</label>
                    <div className="font-bold text-slate-900 uppercase">Alice Writer</div>
                </div>
                <div>
                    <label className="block text-xs font-black text-slate-400 uppercase mb-1">Priority</label>
                    <div className={`font-bold uppercase ${project.priority === 'HIGH' ? 'text-red-600' : 'text-slate-900'}`}>
                        {project.priority}
                    </div>
                </div>
                 <div>
                    <label className="block text-xs font-black text-slate-400 uppercase mb-1">CMO Status</label>
                    <div className="font-bold text-green-600 uppercase flex items-center">
                        <Check className="w-4 h-4 mr-1" /> Approved
                    </div>
                </div>
                 <div>
                    <label className="block text-xs font-black text-slate-400 uppercase mb-1">Due Date</label>
                    <div className="font-bold text-slate-900 uppercase">Today</div>
                </div>
            </div>

            {/* Script Viewer */}
            <section className="space-y-4">
                <div className="flex items-center justify-between">
                    <h3 className="text-2xl font-black text-slate-900 uppercase">Script & Message</h3>
                    <button className="text-sm font-bold uppercase flex items-center bg-white border-2 border-black px-4 py-2 hover:bg-slate-100 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-[2px] active:shadow-none transition-all">
                        <Download className="w-4 h-4 mr-2" /> Download PDF
                    </button>
                </div>
                <div className="border-2 border-black bg-white p-8 min-h-[300px] whitespace-pre-wrap font-serif text-lg leading-relaxed text-slate-900 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                    {project.data.script_content || 'No script content available.'}
                </div>
            </section>

            {/* Assets Section (Only if final review or assets exist) */}
            <section className="space-y-4 pt-6 border-t-4 border-black">
                 <h3 className="text-2xl font-black text-slate-900 uppercase">Production Assets</h3>
                 
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Video Asset */}
                    {isVideo && (
                         <div className="border-2 border-black bg-white shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                            <div className="aspect-video bg-black flex items-center justify-center text-white border-b-2 border-black">
                                <Video className="w-16 h-16 opacity-50" />
                            </div>
                            <div className="p-4 flex justify-between items-center bg-white">
                                <div>
                                    <p className="font-black text-slate-900 text-sm uppercase">Master_Edit_Final.mp4</p>
                                    <p className="text-xs text-slate-500 font-bold">1080p • 24mb</p>
                                </div>
                                <a href={project.data.master_link || '#'} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline text-sm font-black uppercase">View File</a>
                            </div>
                         </div>
                    )}

                     {/* Image/Thumbnail Asset */}
                    <div className="border-2 border-black bg-white shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                        <div className="aspect-video bg-slate-100 flex items-center justify-center text-slate-300 border-b-2 border-black">
                            <ImageIcon className="w-16 h-16" />
                        </div>
                        <div className="p-4 flex justify-between items-center bg-white">
                            <div>
                                <p className="font-black text-slate-900 text-sm uppercase">Thumbnail_v3.png</p>
                                <p className="text-xs text-slate-500 font-bold">PNG • 2mb</p>
                            </div>
                             <a href={project.data.thumbnail_link || '#'} target="_blank" rel="noreferrer" className="text-blue-600 hover:underline text-sm font-black uppercase">View File</a>
                        </div>
                    </div>
                 </div>
            </section>
        </div>

        {/* RIGHT COLUMN: Approval Panel (30%) - Sticky */}
        <div className="w-full md:w-[450px] bg-white border-l-2 border-black p-8 shadow-[-10px_0px_20px_rgba(0,0,0,0.05)] sticky bottom-0 md:top-20 md:h-[calc(100vh-80px)] overflow-y-auto z-10 flex flex-col">
            <h2 className="text-2xl font-black text-slate-900 uppercase mb-8 border-b-4 border-black pb-2 inline-block">Final Decision</h2>
            
            <div className="space-y-4 flex-1">
                {/* Approve Option */}
                <label className={`block p-6 border-2 cursor-pointer transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[-2px] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] ${decision === 'APPROVE' ? 'border-black bg-[#4ADE80]' : 'border-black bg-white hover:bg-slate-50'}`}>
                    <div className="flex items-center">
                        <input 
                            type="radio" 
                            name="decision" 
                            className="w-5 h-5 accent-black"
                            checked={decision === 'APPROVE'} 
                            onChange={() => setDecision('APPROVE')}
                        />
                        <div className="ml-4 flex-1">
                            <span className="block font-black text-lg uppercase text-slate-900">Approve Content</span>
                            <span className="text-xs font-bold uppercase text-slate-600">
                                {project.current_stage.includes('SCRIPT') ? 'Move to Production' : 'Ready for Publishing'}
                            </span>
                        </div>
                        <Check className="w-8 h-8 ml-auto text-black" />
                    </div>
                </label>

                {/* Rework Option */}
                <label className={`block p-6 border-2 cursor-pointer transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[-2px] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] ${decision === 'REWORK' ? 'border-black bg-[#FFD952]' : 'border-black bg-white hover:bg-slate-50'}`}>
                     <div className="flex items-center">
                        <input 
                            type="radio" 
                            name="decision" 
                            className="w-5 h-5 accent-black"
                            checked={decision === 'REWORK'} 
                            onChange={() => { setDecision('REWORK'); setReworkStage(''); }}
                        />
                        <div className="ml-4 flex-1">
                            <span className="block font-black text-lg uppercase text-slate-900">Request Rework</span>
                            <span className="text-xs font-bold uppercase text-slate-600">Send back for edits</span>
                        </div>
                        <RotateCcw className="w-8 h-8 ml-auto text-black" />
                    </div>
                </label>

                {/* Reject Option */}
                <label className={`block p-6 border-2 cursor-pointer transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[-2px] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] ${decision === 'REJECT' ? 'border-black bg-[#FF4F4F] text-white' : 'border-black bg-white hover:bg-slate-50'}`}>
                     <div className="flex items-center">
                        <input 
                            type="radio" 
                            name="decision" 
                            className="w-5 h-5 accent-black"
                            checked={decision === 'REJECT'} 
                            onChange={() => setDecision('REJECT')}
                        />
                        <div className="ml-4 flex-1">
                            <span className={`block font-black text-lg uppercase ${decision === 'REJECT' ? 'text-white' : 'text-slate-900'}`}>Reject</span>
                            <span className={`text-xs font-bold uppercase ${decision === 'REJECT' ? 'text-white/80' : 'text-slate-600'}`}>Terminate workflow</span>
                        </div>
                        <X className={`w-8 h-8 ml-auto ${decision === 'REJECT' ? 'text-white' : 'text-black'}`} />
                    </div>
                </label>
            </div>

            <div className="my-8 border-t-2 border-dashed border-slate-300"></div>

            {/* Conditional Inputs */}
            <div className="space-y-6">
                {decision === 'REWORK' && (
                    <div className="animate-fade-in space-y-2">
                        <label className="block text-xs font-black text-slate-500 uppercase">Send back to</label>
                        <select 
                            className="w-full p-4 border-2 border-black bg-white focus:bg-yellow-50 focus:outline-none font-bold text-sm uppercase shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]"
                            value={reworkStage}
                            onChange={(e) => setReworkStage(e.target.value)}
                        >
                            <option value="">-- Select Role --</option>
                            {getReworkOptions().map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                        </select>
                    </div>
                )}

                {(decision === 'REWORK' || decision === 'REJECT' || decision === 'APPROVE') && (
                     <div className="animate-fade-in space-y-2">
                         <label className="block text-xs font-black text-slate-500 uppercase">
                            {decision === 'APPROVE' ? 'Notes (Optional)' : 'Reason (Required)'}
                         </label>
                         <textarea 
                            value={comment}
                            onChange={(e) => setComment(e.target.value)}
                            placeholder={decision === 'APPROVE' ? "Good job..." : "Please fix..."}
                            className="w-full p-4 border-2 border-black rounded-none text-sm min-h-[120px] focus:bg-yellow-50 focus:outline-none font-medium resize-none shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)]"
                        />
                     </div>
                )}
            </div>

            <div className="mt-8">
                <button 
                    disabled={!decision || isSubmitting || (decision === 'REWORK' && !reworkStage) || ((decision === 'REWORK' || decision === 'REJECT') && !comment)}
                    onClick={handleSubmit}
                    className={`w-full py-5 border-2 border-black font-black uppercase text-lg shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:translate-y-[2px] hover:translate-x-[2px] hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:shadow-none active:translate-y-[6px] active:translate-x-[6px] transition-all flex justify-center items-center ${
                        decision === 'REWORK' ? 'bg-[#FFD952] text-black' :
                        decision === 'REJECT' ? 'bg-[#FF4F4F] text-white' :
                        decision === 'APPROVE' ? 'bg-[#0085FF] text-white' :
                        'bg-slate-200 text-slate-400 cursor-not-allowed border-slate-300 shadow-none'
                    }`}
                >
                    {isSubmitting ? (
                        <div className="w-6 h-6 border-4 border-current border-t-transparent rounded-full animate-spin" />
                    ) : decision === 'REWORK' ? 'Send For Rework' :
                      decision === 'REJECT' ? 'Confirm Rejection' :
                      decision === 'APPROVE' ? 'Approve & Continue' :
                      'Select Action'
                    }
                </button>
            </div>
        </div>
      </div>
    </div>
  );
};

export default CeoReviewScreen;
